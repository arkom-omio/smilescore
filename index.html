<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmileScore ‚Äî –æ—Ü–µ–Ω–∫–∞ —É–ª—ã–±–∫–∏</title>
  <meta name="description" content="–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —É–ª—ã–±–∫–∏ –ø–æ —Ñ–æ—Ç–æ. –ù–∏—á–µ–≥–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body,#root{height:100%} body{background:#0b0b0f}
    #err{position:fixed;inset:0;display:none;background:rgba(0,0,0,.92);color:#fff;padding:16px;z-index:99999;white-space:pre-wrap}
  </style>
</head>
<body>
  <div id="root"></div>
  <div id="err"></div>

  <script>
    addEventListener('error', e => {
      var el=document.getElementById('err'); el.textContent='JS error: '+(e&&e.message||e); el.style.display='block';
    });
    addEventListener('unhandledrejection', e => {
      var el=document.getElementById('err'); var r=e&&e.reason; el.textContent='Promise: '+(r&&(r.message||r)||e); el.style.display='block';
    });
  </script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-presets="env,react">
    /* ==== –æ–±–ª–µ–≥—á—ë–Ω–Ω—ã–µ "motion" —Å—Ç–∞–±—ã ==== */
    const AnimatePresence = ({ children }) => <>{children}</>;
    const motion = new Proxy({}, { get: (_t, tag) => (props) => React.createElement(tag, props) });
    /* ================================== */

    const { useEffect, useRef, useState } = React;
    const prettyDate = () => new Date().toLocaleString();
    const MAX_SIZE = 15 * 1024 * 1024;

    /* ====== –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞–Ω–∞–ª–∏–∑–∞, DropZone, ScoreRing, Metric, Toast –∏ —Ç.–¥. –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ====== */

    /* ======================= –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ======================= */
    function App(){
      const [file,setFile]=useState(null);
      const [imgURL,setImgURL]=useState(null);
      const [imgTooDark,setImgTooDark]=useState(false);
      const [score,setScore]=useState(null);
      const [metrics,setMetrics]=useState(null);
      const [busy,setBusy]=useState(false);
      const [autoAnalyze,setAutoAnalyze]=useState(true);
      const [history,setHistory]=useState([]);
      const [toast,setToast]=useState(null);

      const [camOn,setCamOn]=useState(false);
      const [videoReady,setVideoReady]=useState(false);
      const videoRef=useRef(null);
      const streamRef=useRef(null);

      async function acceptFile(f){
        try{
          setScore(null); setMetrics(null); setImgTooDark(false);
          const safe=await fileToSafeDataURL(f);
          setImgURL(safe);
          setFile(f);
        }catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ JPG/PNG.'); }
      }

      const imageData=useImageData(imgURL);
      useEffect(function(){
        if(!imgURL){ setMetrics(null); setScore(null); return; }
        const m=analyzeJoy(imageData); setMetrics(m); setScore(null);
        const dark = m && m.brightness<0.02 && m.saturation<0.02;
        setImgTooDark(!!dark);
      },[imgURL,imageData]);

      useEffect(function(){
        if(!autoAnalyze||!imgURL||!metrics) return;
        if(score!=null||busy) return;
        (async function(){ await handleAnalyze(); })();
      },[autoAnalyze,imgURL,metrics,score,busy]);

      async function handleAnalyze(){
        if(!imgURL){ setToast('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ'); return; }
        setBusy(true);
        var m = metrics || analyzeJoy(imageData); if(!m) m=analyzeJoy(null);
        if(!metrics) setMetrics(m);
        await new Promise(function(r){ setTimeout(r,320); });
        const s=scoreFromMetrics(m); setScore(s); setBusy(false); setToast('–ì–æ—Ç–æ–≤–æ! –£–ª—ã–±–∫–∞ –æ—Ü–µ–Ω–µ–Ω–∞ üòä');
        if(file){
          try{ setHistory(function(prev){ return [{url:imgURL,score:s,verdict:verdict(s),date:prettyDate()}].concat(prev).slice(0,6); }); }catch(e){}
        }
      }

      function reset(){ setFile(null); setImgURL(null); setImgTooDark(false); setScore(null); setMetrics(null); }

      /* === –£–ë–†–ê–ù–û: makeDemoPhoto === */

      async function startCamera(){
        try{
          reset();
          setVideoReady(false);
          const stream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'user' } }, audio:false });
          streamRef.current=stream;
          const v=videoRef.current;
          if(v){
            v.srcObject=stream;
            v.setAttribute('playsinline','true');
            v.muted=true;
            await ensureVideoReady(v);
            setVideoReady(true);
          }
          setCamOn(true);
        }catch(e){
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É: '+((e&&e.message)||e));
        }
      }
      function stopCamera(){
        const s=streamRef.current; if(s){ s.getTracks().forEach(function(t){ t.stop(); }); streamRef.current=null; }
        if(videoRef.current) videoRef.current.srcObject=null;
        setVideoReady(false);
        setCamOn(false);
      }
      async function takePhoto(){
        const v=videoRef.current; if(!v) return;

        var track=null;
        if(streamRef.current && typeof streamRef.current.getVideoTracks==='function'){
          const tr=streamRef.current.getVideoTracks(); if(tr && tr.length) track=tr[0];
        }
        if(track && window.ImageCapture){
          try{
            const cap=new window.ImageCapture(track);
            const blob=await cap.takePhoto();
            setFile(new File([blob],'camera-shot.jpg',{type: blob.type || 'image/jpeg'}));
            stopCamera(); return;
          }catch(e){ }
        }

        await ensureVideoReady(v);

        for(var attempt=0; attempt<10; attempt++){
          const shot=await captureFrameFromVideo(v);
          if(shot && shot.blob && shot.brightness>0.03){
            setFile(new File([shot.blob],'camera-shot.jpg',{type:'image/jpeg'}));
            stopCamera(); return;
          }
          await nextVideoFrame(v);
          await new Promise(function(r){ setTimeout(r,80); });
        }
        alert('–ö–∞–º–µ—Ä–∞ –æ—Ç–¥–∞–ª–∞ —Å–ª–∏—à–∫–æ–º —Ç—ë–º–Ω—ã–π –∫–∞–¥—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Å–≤–µ—Ç–∞.');
      }

      /* ===== –ö–Ω–æ–ø–∫–∏ ===== */
      return (<div className={'min-h-screen text-white'}>
        <main className="mx-auto max-w-6xl px-4 py-10 md:py-16">
          <div className="mt-10 grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div className="space-y-4">
              {/* DropZone / —Ñ–æ—Ç–æ / –∫–∞–º–µ—Ä–∞ */}
              {/* ‚Ä¶ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Ä¶ */}

              <div className="flex flex-wrap items-center gap-3">
                <button onClick={handleAnalyze} disabled={!imgURL || busy}
                  className="rounded-2xl bg-white text-black px-5 py-3 text-sm font-medium shadow-lg disabled:opacity-40 disabled:cursor-not-allowed">
                  {busy?'–ê–Ω–∞–ª–∏–∑‚Ä¶':'–û—Ü–µ–Ω–∏—Ç—å —É–ª—ã–±–∫—É'}
                </button>

                <button onClick={exportPNG} disabled={!score || !imgURL}
                  className="rounded-2xl bg-white/10 hover:bg-white/20 px-4 py-3 text-sm disabled:opacity-40 disabled:cursor-not-allowed">
                  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å PNG
                </button>

                <label className="flex items-center gap-2 text-white/70 text-sm select-none">
                  <input type="checkbox" checked={autoAnalyze} onChange={e=>setAutoAnalyze(e.currentTarget.checked)} className="accent-white"/> 
                  –ê–≤—Ç–æ-–æ—Ü–µ–Ω–∫–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                </label>
              </div>

              {/* –ò—Å—Ç–æ—Ä–∏—è */}
              {/* ‚Ä¶ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Ä¶ */}
            </div>

            {/* –ü—Ä–∞–≤—ã–π –±–ª–æ–∫ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ */}
            {/* ‚Ä¶ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Ä¶ */}
          </div>
        </main>
        {toast && <Toast message={toast} onClose={()=>setToast(null)}/>}
      </div>);
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
